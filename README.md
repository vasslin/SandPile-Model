# Abelian SandPile Model

## Описание

Abelian SandPile Model - упрощенная [модель песчаной кучи](https://en.wikipedia.org/wiki/Abelian_sandpile_model), которая позволяет сохранять свои состояния в картинку в формате BMP.

Изначальное состояние задается входным файлом в формате tsv.

Размер сетки может изменяться в процессе работы программы.

Реализация - консольное приложение, поддерживающее следующие аргументы командной строки:

  **-i, --input**    - tsv-файл c начальными данными

  **-o, --output**   - путь к директории для сохранения картинок

  **-m, --max-iter** - максимальное количество итераций модели

  **-f, --freq**     - частота, с которой должны сохранятся картинки (если 0, то сохраняется только последнее состояние)

### Начальное состояние

Начальное состояние задается файлом со значением количества песчинок в каждой ячейке, кроме пустых. Размер сетки - минимальный прямоугольник в который попадают все ячейки.

Формат файла:
Каждая строчка содержит информацию об одной ячейке, в виде (x-координаты, y-координаты, количество песчинок), разделенных символом табуляции. Количество песчинок гарантированно влезает в `uint64_t`, координаты гарантированно влезают в `int16_t`

### Примечания к модели

1. Новые песчинки добавляются только при инициализации.

2. Состояние следующего поколения ячеек зависит только от предыдущего состояния сетки.

3. В случае если песчинки пытаются обвалиться за границу сетки, ее размер увеличивается в соответствующую сторону.

### Результат

Программа пересчитывает состояние модели согласно начальным данным, а также сохраняет промежуточные состояния с заданной частотой в виде картинки в формате bmp.

Картинка для текущего состояния формируется по следующим правилам:

1. Размер картинки равен размеру поля.

2. Каждый пиксель соответствует ячейке поля.

3. Цвет пикселя зависит от количества песчинок в ячейке.
  
    + 0 - белый
    + 1 - зеленый
    + 2 - фиолетовый
    + 3 - желтый
    + \> 3 - черный

4. Кодирование 1 пикселя занимает не более 4 бит.

Программа заканчивает свою работу в случае, если модель достигла стабильного состояния, либо номера заданной изначально итерации.

## Структура проекта

```
sandpile_model
├── lib/   
│   ├── bmp_lib/                
│   │   ├── bmp_writer.h        # объявление класса для записи состояний кучи в формат bmp
│   │   ├── bmp_writer.cpp      # его определение
│   │   └── CMakeLists.txt      # файл для сборки
│   ├── parser_lib/   
│   │   ├── parser.h            # объявление функции parseData, считывающей параметры, переданные в качестве аргументов командной строки
│   │   ├── parser.cpp          # ее определение
│   │   └── CMakeLists.txt      # файл для сборки
│   └── sandpile_lib/   
│       ├── lattice_block.h     # объявление блока-элемента двумерного списка, хранящего состояние кучи
│       ├── lattice_block.cpp
│       ├── sandpile_model.h    # объявление модели песчаной кучи
│       ├── sandpile_model.cpp  
│       └── CMakeLists.txt      # файл для сборки
│
├── bin/   
│   ├── main.cpp
│   └── CMakeLists.txt
└── README.md

```

## Хранение состояний песчаной кучи

Состояния песчаной кучи хранятся в 2d-linked list - структуре данных, представляющей из себя сетку из элементов LatticeBlock. 
_LatticeBlock_ - элемент с двумерным массивом данных и указателями на LatticeBlock'и с четырех сторон.

Использование данной структуры позволяет эффективнее работать с памятью:
- выделение целого блока памяти, попадание в кэш,
- при увеличении размера сетки добавляется ряд из LatticeBlock'ов с соответствующей стороны (отсутствует необходимость реаллокации памяти и перекопирования всех элементов при увеличении размера сетки)
